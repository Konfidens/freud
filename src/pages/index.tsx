import Head from "next/head";
import React, { useEffect, useState } from "react";
import { SidebarFreud } from "~/SidebarFreud";
import { VectorStoreSettings } from "~/components/VectorStoreSettings";
import { type Message } from "~/interfaces/message";

import { env } from "~/env.mjs";
import Header from "~/components/Header";
import Chat from "~/components/Chat";
import SelectCategories from "~/components/SelectCategories";
import { api } from "~/utils/api";
import { z } from "zod";
import { Button } from "~/components/ui/button/Button";

export const Categories = z.record(
  z.string(),
  z.object({ active: z.boolean() })
);

export type Categories = z.infer<typeof Categories>;

// export type Categories = { [key: string]: { active: boolean } };

export default function Home() {
  const [messages, setMessages] = useState<Message[]>([]);
  const [showSettings, setShowSettings] = useState<boolean>(false);
  const [categories, setCategories] = useState<Categories>({});

  const fetchedCategories = api.weaviate.listSchemas.useMutation({
    onSuccess: (data) => {
      if (!data) {
        throw new Error("Data not defined in OnSuccess");
      }

      const fetched_keys: string[] = [];
      data.classes?.forEach((item) => {
        let name: string;
        if (!item.class) {
          name = "Kategori uten navn";
        } else {
          name = item.class;
        }
        fetched_keys.push(name);
      });

      fetched_keys.map((name) => {
        setCategories((prevState) => ({
          ...prevState,
          [name]: { active: false },
        }));
      });

    },
  });

  useEffect(() => {
    fetchedCategories.mutate();
    let localstore_categories: { [name: string]: { active: boolean } } = {};
    let localstore_keys: string[] = [];

    if (localStorage.getItem("categories")) {
      localstore_categories = JSON.parse(
        localStorage.getItem("categories") as string
      ) as { [name: string]: { active: boolean } };

      localstore_keys = Object.keys(
        localstore_categories
      ).sort((a, b) => a.localeCompare(b));

      localstore_keys.forEach((name) => {
        setCategories((prevState) => ({
          ...prevState,
          [name]: { active: localstore_categories[name]?.active as boolean},
        }));
      })
    }
  }, []);

  useEffect(() => {
    setTimeout(() => {localStorage.setItem("categories", JSON.stringify(categories))}, 2000);
  }, [categories]);

  function tempHandleClick() {
    console.log("\nCategories from button:", categories);
    console.log(
      "Categories from localstore:",
      localStorage.getItem("categories")
    );
  }

  return (
    <>
      <Head>
        <title>Freud</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/sigmund_freud_avatar.png" />
      </Head>
      <main
        className={`flex min-h-screen flex-col items-center justify-between bg-beige100 pb-8`}
      >
        <SidebarFreud
          showSettings={showSettings}
          setShowSettings={setShowSettings}
        >
          <>
            <SelectCategories categories={categories} myfunc={setCategories} />
            {env.NEXT_PUBLIC_NODE_ENV == "development" && (
              <VectorStoreSettings vectorStoreSchemas={fetchedCategories} />
            )}
          </>
        </SidebarFreud>
        {/* get content in center at start */}
        <div />
        <div />
        <Header chatStarted={messages.length > 0} />
        <Button onClick={tempHandleClick} />
        <Chat
          messages={messages}
          setMessages={setMessages}
          categories={categories}
        />
      </main>
    </>
  );
}
